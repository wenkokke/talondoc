name: Build & Test

on:
    push:
        branches:
            - "*"
        tags:
            - "*"
    pull_request:
        types:
            - opened
            - synchronize

defaults:
    run:
        shell: bash

jobs:
    build:
        name: Build & Test
        strategy:
            matrix:
                os: [ubuntu-latest, macos-latest, windows-latest]
                python-version: ["3.9", "3.10"]
                build-format: ["wheel"]
                include:
                    - experimental: false
                    - os: windows-latest
                      experimental: true
        runs-on: ${{ matrix.os }}
        continue-on-error: ${{ matrix.experimental }}
        steps:
            - uses: actions/checkout@v3
              with:
                  submodules: true

            - name: Setup Python
              uses: ./.github/actions/setup-python
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Build
              run: poetry build -vvv --format=${{ matrix.build-format }}

            - name: Build & Test
              run: tox --skip-missing

            - name: Build Doc
              run: |
                  poetry install --all-extras
                  sh ./scripts/build-doc

            - name: Upload wheel
              if: ${{ matrix.build-format }} == 'wheel'
              uses: actions/upload-artifact@v3
              with:
                  name: wheelhouse
                  path: dist/**.whl

    build-doc:
        name: Build Doc
        needs: [build]
        if: github.event_name == 'push'
        uses: ./.github/workflows/build-doc.yml

    release:
        name: Release
        needs: [build]
        if: startsWith(github.ref, 'refs/tags/')
        uses: ./.github/workflows/release.yml
